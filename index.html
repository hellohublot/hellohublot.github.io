<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hellohublot.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="时光荏苒">
<meta property="og:url" content="https://hellohublot.github.io/index.html">
<meta property="og:site_name" content="时光荏苒">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="hublot@aliyun.com">
<meta property="article:tag" content="hublot">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://hellohublot.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>时光荏苒</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">时光荏苒</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hellohublot.github.io/2022/05/23/How%20to%20use%20ReactNative%20to%20realize%20all%20the%20functions%20of%20Huobi%20K-line/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hublot@aliyun.com">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光荏苒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/23/How%20to%20use%20ReactNative%20to%20realize%20all%20the%20functions%20of%20Huobi%20K-line/" class="post-title-link" itemprop="url">How to use ReactNative to realize all the functions of Huobi K-line</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-23 16:50:14" itemprop="dateCreated datePublished" datetime="2022-05-23T16:50:14+08:00">2022-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-24 14:59:12" itemprop="dateModified" datetime="2023-02-24T14:59:12+08:00">2023-02-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Data-transfer"><a href="#Data-transfer" class="headerlink" title="Data transfer"></a>Data transfer</h2><p>We can’t directly pass Dictionary to Native, because yogo will parse these large amounts of data, which will cause performance problems. We’d better serialize them into JSON strings and pass large amounts of data between JS and Native. We calculate all index values in the background thread and then update the UI on the main thread</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RNKLineView</span></span><br><span class="line"><span class="meta">@objc</span> <span class="function">func <span class="title">reloadOptionList</span><span class="params">(_ reactTag: NSNumber, optionList: String)</span> </span>&#123;</span><br><span class="line">     bridge.uiManager.addUIBlock &#123; (uimanager, viewRegistry) in</span><br><span class="line">         guard let viewRegistry = viewRegistry, let containerView = viewRegistry[reactTag] as? HTKLineContainerView <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         type(of: self). queue. async &#123;</span><br><span class="line">             <span class="keyword">do</span> &#123;</span><br><span class="line">                 guard let optionList = <span class="keyword">try</span> JSONSerialization.jsonObject(with: optionList.data(using: .utf8) ?? Data(), options: .allowFragments) as? [String: Any] <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span></span><br><span class="line">                 &#125;</span><br><span class="line">                 containerView.configManager.reloadOptionList(optionList)</span><br><span class="line">                 DispatchQueue. main. async &#123;</span><br><span class="line">                     containerView. reloadConfigManager(containerView.configManager)</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">catch</span>(_) &#123;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chart-wrapper"><a href="#Chart-wrapper" class="headerlink" title="Chart wrapper"></a>Chart wrapper</h2><p>There are many kinds of charts and indicators that need to be drawn, so we encapsulate the same parts of them into protocols. Similarly, in swift, we can add default implementations to protocols, or add public methods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineDrawProtocolx</span></span><br><span class="line">protocol HTKLineDrawProtocol: <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function">func <span class="title">minMaxRange</span><span class="params">(_ visibleModelArray: [HTKLineModel], _ configManager: HTKLineConfigManager)</span> -&gt; Range&lt;CGFloat&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">     func <span class="title">drawCandle</span><span class="params">(_ model: HTKLineModel, _ index: Int, _ maxValue: CGFloat, _ minValue: CGFloat, _ baseY: CGFloat, _ height: CGFloat, _ context: CGContext, _ configManager: HTKLineConfigManager)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">     func <span class="title">drawLine</span><span class="params">(_ model: HTKLineModel, _ lastModel: HTKLineModel, _ maxValue: CGFloat, _ minValue: CGFloat, _ baseY: CGFloat, _ height: CGFloat, _ index: Int, _ lastIndex: Int, _ context: CGContext, _ configManager : HTKLineConfigManager)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">     func <span class="title">drawText</span><span class="params">(_ model: HTKLineModel, _ baseX: CGFloat, _ baseY: CGFloat, _ context: CGContext, _ configManager: HTKLineConfigManager)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">     func <span class="title">drawValue</span><span class="params">(_ maxValue: CGFloat, _ minValue: CGFloat, _ baseX: CGFloat, _ baseY: CGFloat, _ height: CGFloat, _ context: CGContext, _ configManager: HTKLineConfigManager)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>


<h2 id="Chart-drawing"><a href="#Chart-drawing" class="headerlink" title="Chart drawing"></a>Chart drawing</h2><h3 id="Drawing-processing"><a href="#Drawing-processing" class="headerlink" title="Drawing processing"></a>Drawing processing</h3><p>We need a common point conversion method. We first draw the candles of the main chart and the sub-chart, and then draw the text, ruler, maximum and minimum, time scale, current price horizontal line, long-pressed detail panel, etc.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineView</span></span><br><span class="line"><span class="function">override func <span class="title">draw</span><span class="params">(_ rect: CGRect)</span> </span>&#123;</span><br><span class="line">     guard let context = UIGraphicsGetCurrentContext(), configManager.modelArray.count &gt; <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     calculateBaseHeight()</span><br><span class="line">     contextTranslate(context, CGFloat(visibleRange.lowerBound) * configManager.itemWidth, &#123; context in</span><br><span class="line">         drawCandle(context)</span><br><span class="line">     &#125;)</span><br><span class="line"></span><br><span class="line">     contextTranslate(context, contentOffset.x, &#123; context in</span><br><span class="line"></span><br><span class="line">         drawText(context)</span><br><span class="line">         drawValue(context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         drawHighLow(context)</span><br><span class="line">         drawTime(context)</span><br><span class="line">         drawClosePrice(context)</span><br><span class="line">         drawSelectedLine(context)</span><br><span class="line">         drawSelectedBoard(context)</span><br><span class="line">         drawSelectedTime(context)</span><br><span class="line">        </span><br><span class="line">         drawContext. draw(contentOffset. x)</span><br><span class="line">     &#125;)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scroll-Gesture-Handling"><a href="#Scroll-Gesture-Handling" class="headerlink" title="Scroll Gesture Handling"></a>Scroll Gesture Handling</h3><p>When the ScrollView scrolls horizontally, in order to save performance, we only draw in the visible range of the screen, and then calculate the accurate offset for drawing</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineView</span></span><br><span class="line"><span class="function">func <span class="title">scrollViewDidScroll</span><span class="params">(_ scrollView: UIScrollView)</span> </span>&#123;</span><br><span class="line">     let contentOffsetX = scrollView. contentOffset. x</span><br><span class="line">     <span class="keyword">var</span> visibleStartIndex = Int(floor(contentOffsetX / configManager. itemWidth))</span><br><span class="line">     <span class="keyword">var</span> visibleEndIndex = Int(ceil((contentOffsetX + scrollView. bounds. size. width) / configManager. itemWidth))</span><br><span class="line">     visibleStartIndex = min(max(<span class="number">0</span>, visibleStartIndex), configManager.modelArray.count - <span class="number">1</span>)</span><br><span class="line">     visibleEndIndex = min(max(<span class="number">0</span>, visibleEndIndex), configManager.modelArray.count - <span class="number">1</span>)</span><br><span class="line">     visibleRange = visibleStartIndex...visibleEndIndex</span><br><span class="line">     self. setNeedsDisplay()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Zoom-gesture-handling"><a href="#Zoom-gesture-handling" class="headerlink" title="Zoom gesture handling"></a>Zoom gesture handling</h3><p>When the ScrollView pinch zoom gesture, we need to recalculate the offset for drawing</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineView</span></span><br><span class="line"><span class="meta">@objc</span></span><br><span class="line"><span class="function">func <span class="title">pinchSelector</span><span class="params">(_ gesture: UIPinchGestureRecognizer)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> gesture. state &#123;</span><br><span class="line">     <span class="keyword">case</span>.changed:</span><br><span class="line">         scale += (gesture. scale - <span class="number">1</span>) / <span class="number">10</span></span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">     &#125;</span><br><span class="line">     scale = max(<span class="number">0.3</span>, min(scale, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">     let width = bounds. size. width</span><br><span class="line">     let halfWidth = width / <span class="number">2</span></span><br><span class="line">     let offsetScale = (contentOffset.x + halfWidth) / (contentSize.width - configManager.paddingRight)</span><br><span class="line"></span><br><span class="line">     reloadContentSize()</span><br><span class="line">     let contentOffsetX = max(<span class="number">0</span>, min((contentSize. width - configManager. paddingRight) * offsetScale - halfWidth, contentSize. width - width))</span><br><span class="line">     reloadContentOffset(contentOffsetX)</span><br><span class="line">     scrollViewDidScroll(self)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Long-press-gesture-panel-processing"><a href="#Long-press-gesture-panel-processing" class="headerlink" title="Long press gesture panel processing"></a>Long press gesture panel processing</h3><p>When ScrollView receives a long press or click gesture, we need to show or hide the details panel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineView</span></span><br><span class="line"><span class="meta">@objc</span></span><br><span class="line"><span class="function">func <span class="title">longPressSelector</span><span class="params">(_ gesture: UILongPressGestureRecognizer)</span> </span>&#123;</span><br><span class="line">     let index = Int(floor(gesture. location(in: self). x / configManager. itemWidth))</span><br><span class="line">     selectedIndex = index</span><br><span class="line">     <span class="keyword">if</span> (selectedIndex &gt;= configManager. modelArray. count) &#123;</span><br><span class="line">         selectedIndex = configManager.modelArray.count - <span class="number">1</span></span><br><span class="line">     &#125;</span><br><span class="line">     self. setNeedsDisplay()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chart-magnifying-glass"><a href="#Chart-magnifying-glass" class="headerlink" title="Chart magnifying glass"></a>Chart magnifying glass</h2><p>We integrate all the charts into the container HTKLineContainerView, where we handle the display of the magnifying glass according to gestures</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineContainerView</span></span><br><span class="line"><span class="function">func <span class="title">touchesGesture</span><span class="params">(_ touched: Set&lt;UITouch&gt;, _ state: UIGestureRecognizerState)</span> </span>&#123;</span><br><span class="line">     guard <span class="keyword">var</span> location = touched.first?.location(in: self) <span class="keyword">else</span> &#123;</span><br><span class="line">         shotView. shotPoint = nil</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">var</span> previousLocation = touched.first?.previousLocation(in: self) ?? location</span><br><span class="line">     location = convertLocation(location)</span><br><span class="line">     previousLocation = convertLocation(previousLocation)</span><br><span class="line">    </span><br><span class="line">     let translation = CGPoint.init(x: location.x - previousLocation.x, y: location.y - previousLocation.y)</span><br><span class="line">    </span><br><span class="line">     klineView.drawContext.touchesGesture(location, translation, state)</span><br><span class="line">     shotView.shotPoint = state != .ended ? touched.first?.location(in: self) : nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Finger-marker-drawing"><a href="#Finger-marker-drawing" class="headerlink" title="Finger marker drawing"></a>Finger marker drawing</h2><p>Our finger mark drawings are all drawn through HTDrawContext, we need to pay attention to including parallelograms, we need to convert all coordinates to the current price coordinates, because our zoom gesture needs to keep these finger mark drawings in the correct position</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTKLineContainerView</span></span><br><span class="line"><span class="function">func <span class="title">reloadConfigManager</span><span class="params">(_ configManager: HTKLineConfigManager)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     configManager.onDrawItemDidTouch = &#123; [weak self] (drawItem, drawItemIndex) in</span><br><span class="line">         self?.configManager.shouldReloadDrawItemIndex = drawItemIndex</span><br><span class="line">         guard let drawItem = drawItem, let colorList = drawItem.drawColor.cgColor.components <span class="keyword">else</span> &#123;</span><br><span class="line">             self?.onDrawItemDidTouch?([</span><br><span class="line">                 <span class="string">&quot;shouldReloadDrawItemIndex&quot;</span>: drawItemIndex,</span><br><span class="line">             ])</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         self?.onDrawItemDidTouch?([</span><br><span class="line">             <span class="string">&quot;shouldReloadDrawItemIndex&quot;</span>: drawItemIndex,</span><br><span class="line">             <span class="string">&quot;drawColor&quot;</span>: colorList,</span><br><span class="line">             <span class="string">&quot;drawLineHeight&quot;</span>: drawItem. drawLineHeight,</span><br><span class="line">             <span class="string">&quot;drawDashWidth&quot;</span>: drawItem. drawDashWidth,</span><br><span class="line">             <span class="string">&quot;drawDashSpace&quot;</span>: drawItem. drawDashSpace,</span><br><span class="line">             <span class="string">&quot;drawIsLock&quot;</span>: drawItem. drawIsLock</span><br><span class="line">         ])</span><br><span class="line">     &#125;</span><br><span class="line">     configManager.onDrawItemComplete = &#123; [weak self] (drawItem, drawItemIndex) in</span><br><span class="line">         self?.onDrawItemComplete?([AnyHashable: Any].init())</span><br><span class="line">     &#125;</span><br><span class="line">     configManager.onDrawPointComplete = &#123; [weak self] (drawItem, drawItemIndex) in</span><br><span class="line">         guard let drawItem = drawItem <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         self?.onDrawPointComplete?([</span><br><span class="line">             <span class="string">&quot;pointCount&quot;</span>: drawItem.pointList.count</span><br><span class="line">         ])</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     let reloadIndex = configManager.shouldReloadDrawItemIndex</span><br><span class="line">     <span class="keyword">if</span> reloadIndex &gt;= <span class="number">0</span>, reloadIndex &lt; klineView.drawContext.drawItemList.count &#123;</span><br><span class="line">         let drawItem = klineView.drawContext.drawItemList[reloadIndex]</span><br><span class="line">         drawItem.drawColor = configManager.drawColor</span><br><span class="line">         drawItem.drawLineHeight = configManager.drawLineHeight</span><br><span class="line">         drawItem.drawDashWidth = configManager.drawDashWidth</span><br><span class="line">         drawItem.drawDashSpace = configManager.drawDashSpace</span><br><span class="line">         drawItem.drawIsLock = configManager.drawIsLock</span><br><span class="line">         <span class="keyword">if</span> (configManager. drawShouldTrash) &#123;</span><br><span class="line">             configManager.shouldReloadDrawItemIndex = HTDrawState.showPencil.rawValue</span><br><span class="line">             klineView.drawContext.drawItemList.remove(at: reloadIndex)</span><br><span class="line">             configManager.drawShouldTrash = <span class="keyword">false</span></span><br><span class="line">         &#125;</span><br><span class="line">         klineView.drawContext.setNeedsDisplay()</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">if</span> configManager. shouldFixDraw &#123;</span><br><span class="line">         configManager.shouldFixDraw = <span class="keyword">false</span></span><br><span class="line">         klineView.drawContext.fixDrawItemList()</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (configManager. shouldClearDraw) &#123;</span><br><span class="line">         configManager.drawType = .none</span><br><span class="line">         configManager.shouldClearDraw = <span class="keyword">false</span></span><br><span class="line">         klineView.drawContext.clearDrawItemList()</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Affiliated"><a href="#Affiliated" class="headerlink" title="Affiliated"></a>Affiliated</h2><p>The full code is here <a target="_blank" rel="noopener" href="https://github.com/hellohublot/react-native-kline-view">https://github.com/hellohublot/react-native-kline-view</a><br>I’m hublot, sharing some of my thoughts, I’m too busy with work, it’s inevitable that there will be negligence, please forgive me</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hellohublot.github.io/2022/04/23/How%20to%20use%20ReactNative%20to%20implement%20a%20high-performance%20navigation%20bar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hublot@aliyun.com">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光荏苒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/How%20to%20use%20ReactNative%20to%20implement%20a%20high-performance%20navigation%20bar/" class="post-title-link" itemprop="url">How to use ReactNative to implement a high-performance navigation bar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-23 16:50:14" itemprop="dateCreated datePublished" datetime="2022-04-23T16:50:14+08:00">2022-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-24 14:55:26" itemprop="dateModified" datetime="2023-02-24T14:55:26+08:00">2023-02-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="react-native-swipe-tabs-why-can’t-meet-my-needs"><a href="#react-native-swipe-tabs-why-can’t-meet-my-needs" class="headerlink" title="react-native-swipe-tabs why can’t meet my needs"></a>react-native-swipe-tabs why can’t meet my needs</h2><p>We can know that the best animation performance of ReactNative is LayoutAnimation UIView animation, The best gesture performance is to use NativeEvent. These two solutions point to one direction, that is, to solve the performance problem of ReactNative. We can’t let the busy JS thread participate in these calls, so in terms of performance, I need to change from color to gradient The sliding and size of the text scaling and the scroll bar are all driven by the onScroll nativeEvent event, which is completely separated from the JS call to achieve the best performance</p>
<h2 id="How-to-realize-Label’s-color-gradient-and-text-size-scaling-according-to-onScroll"><a href="#How-to-realize-Label’s-color-gradient-and-text-size-scaling-according-to-onScroll" class="headerlink" title="How to realize Label’s color gradient and text size scaling according to onScroll"></a>How to realize Label’s color gradient and text size scaling according to onScroll</h2><p>We first bind the transform of the Label to the onScroll event. When Native needs to change the transform according to the onScroll calculation, we take the opportunity to change the gradient color of the Native</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTPageHeaderView</span></span><br><span class="line">_itemTitleProps = <span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> fontScale = <span class="number">1</span> + (<span class="built_in">this</span>.itemTitleSelectedStyle.fontSize - <span class="built_in">this</span>.itemTitleNormalStyle.fontSize) / <span class="built_in">this</span>.itemTitleNormalStyle.fontSize</span><br><span class="line">     <span class="keyword">if</span> (fontScale == <span class="number">1</span>) &#123;</span><br><span class="line">         fontScale = <span class="number">1.0001</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">let</span> scale = <span class="built_in">this</span>.scrollPageIndexValue.interpolate(&#123;</span><br><span class="line">         inputRange: [index - <span class="number">2</span>, index - <span class="number">1</span>, index, index + <span class="number">1</span>, index + <span class="number">2</span>],</span><br><span class="line">         outputRange: [<span class="number">1</span>, <span class="number">1</span>, fontScale, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="keyword">let</span> titleStyle = &#123;</span><br><span class="line">         ...</span><br><span class="line">         style: &#123;</span><br><span class="line">             ...this?.props?.itemTitleStyle,</span><br><span class="line">             transform: [&#123; scale &#125;]</span><br><span class="line">         &#125;,</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> titleStyle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We not only need to change the gradient color of the text, because the size of the text has also been changed, so we need to reset the size of the component through setIntrinsicContentSize for other components to re-typesetting</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTSelectedLabel</span></span><br><span class="line">- (<span class="keyword">void</span>) reloadContentSize &#123;</span><br><span class="line">     CGFloat progress = (self.layer.transform.m11 - <span class="number">1</span>) / (self.selectedScale - <span class="number">1</span>);</span><br><span class="line">     self.textColor = [[self class] appendColor:self.normalColor selectedColor:self.selectedColor progress:progress];</span><br><span class="line">     CGSize contentSize = [self sizeThatFits:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX)];</span><br><span class="line">     CGSize size = self. bounds. size;</span><br><span class="line">     <span class="keyword">if</span> (size.width * size.height != <span class="number">0</span> &amp;&amp; !CGSizeEqualToSize(size, CGSizeZero)) &#123;</span><br><span class="line">         contentSize = [self sizeThatFits:size];</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (size.width != contentSize.width || size.height != contentSize.height) &#123;</span><br><span class="line">         [self.bridge.uiManager setIntrinsicContentSize:contentSize forView:self];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="How-to-change-the-position-and-length-of-Cursor-according-to-onScroll"><a href="#How-to-change-the-position-and-length-of-Cursor-according-to-onScroll" class="headerlink" title="How to change the position and length of Cursor according to onScroll"></a>How to change the position and length of Cursor according to onScroll</h2><p>If there is a fixed cursor length, then we can calculate the x offset that the cursor should have for each index<br>If there is no fixed cursor length, then we take the length of Label as the standard</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTPageHeaderCursor</span></span><br><span class="line">_reloadPageIndexValue = <span class="function">(<span class="params">isWidth</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> fixCursorWidth = <span class="built_in">this</span>._findFixCursorWidth()</span><br><span class="line">     <span class="keyword">let</span> rangeList = <span class="function">(<span class="params">isIndex</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> itemList = [isIndex? -<span class="number">1</span> : <span class="number">0</span>]</span><br><span class="line">         itemList = itemList.concat(<span class="built_in">this</span>.itemContainerLayoutList.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (isIndex) &#123;</span><br><span class="line">                 <span class="keyword">return</span> index</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">if</span> (item) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (fixCursorWidth) &#123;</span><br><span class="line">                         <span class="keyword">return</span> isWidth ? fixCursorWidth : (item. x + (item. width - fixCursorWidth) / <span class="number">2.0</span>)</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="keyword">return</span> isWidth ? item. width : (item. x + (item. width) / <span class="number">2.0</span>)</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;))</span><br><span class="line">         itemList = itemList. concat([isIndex ? itemList. length - <span class="number">1</span> : <span class="number">0</span>])</span><br><span class="line">         <span class="keyword">return</span> itemList</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">this</span>.props.scrollPageIndexValue.interpolate(&#123;</span><br><span class="line">         inputRange: rangeList(<span class="literal">true</span>),</span><br><span class="line">         outputRange: rangeList(<span class="literal">false</span>),</span><br><span class="line">     &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="Affiliated"><a href="#Affiliated" class="headerlink" title="Affiliated"></a>Affiliated</h2><p>The full code is here <a target="_blank" rel="noopener" href="https://github.com/hellohublot/react-native-selected-page">https://github.com/hellohublot/react-native-selected-page</a><br>I’m hublot, sharing some of my thoughts, I’m too busy with work, it’s inevitable that there will be negligence, please forgive me</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hellohublot.github.io/2022/03/23/How%20to%20customize%20the%20navigation%20structure%20to%20greatly%20improve%20the%20performance%20of%20your%20ReactNative%20application/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hublot@aliyun.com">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光荏苒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/23/How%20to%20customize%20the%20navigation%20structure%20to%20greatly%20improve%20the%20performance%20of%20your%20ReactNative%20application/" class="post-title-link" itemprop="url">How to customize the navigation structure to greatly improve the performance of your ReactNative application</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-23 16:49:14" itemprop="dateCreated datePublished" datetime="2022-03-23T16:49:14+08:00">2022-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-25 16:52:56" itemprop="dateModified" datetime="2023-02-25T16:52:56+08:00">2023-02-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Where-is-the-performance-bottleneck-of-react-navigation"><a href="#Where-is-the-performance-bottleneck-of-react-navigation" class="headerlink" title="Where is the performance bottleneck of react-navigation"></a>Where is the performance bottleneck of react-navigation</h2><p>We can know that the best animation performance of ReactNative is LayoutAnimation UIView animation, The best gesture performance is to use NativeEvent. These two solutions point to one direction, that is, to solve the performance problem of ReactNative. We cannot let busy JS threads participate in these calls. However, react-navigation from onPress to navigation.push There are JS calls, so our task today is to customize a navigation architecture to greatly improve the performance of our ReactNative application</p>
<h2 id="Encapsulate-NavigationController"><a href="#Encapsulate-NavigationController" class="headerlink" title="Encapsulate NavigationController"></a>Encapsulate NavigationController</h2><p>Starting from the animation, we need to use the UIView process animation that comes with Native. Then the iOS platform already has a UINavigationController library. We only need to create a UINavigationController on the Android platform.</p>
<ul>
<li>We need to handle the hiding of the TabBar</li>
<li>We need to hide the Controller that has been covered by the top page to save memory</li>
<li>And we need to handle viewDidAppear and viewDidDisappear lifecycle</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NavigationController</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">popToViewController</span><span class="params">(<span class="keyword">final</span> HTRouteController controller, Boolean animated)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (childControllerList. size() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>. lock) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">this</span>. lock = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> index = childControllerList. indexOf(controller);</span><br><span class="line">     <span class="keyword">final</span> HTRouteController animatedController = childControllerList. get(childControllerList. size() - <span class="number">1</span>);</span><br><span class="line">     <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">         HTRouteTabBarController tabBarController = HTRouteGlobal.nextController(getView(), HTRouteTabBarController.class);</span><br><span class="line">         <span class="keyword">if</span> (tabBarController != <span class="keyword">null</span>) &#123;</span><br><span class="line">             tabBarController. reloadShowTabBar(<span class="keyword">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     controller.getView().setVisibility(View.VISIBLE);</span><br><span class="line">     translateAnimation(animatedController, animatedController.getView(), <span class="keyword">false</span>, animated, <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">             controller. viewDidAppear();</span><br><span class="line">             animatedController. viewDidDisappear();</span><br><span class="line">             <span class="keyword">int</span> size = childControllerList. size();</span><br><span class="line">             List&lt;HTRouteController&gt; willRemoveControllerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">             <span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt; size; i ++) &#123;</span><br><span class="line">                 HTRouteController removeController = childControllerList. get(i);</span><br><span class="line">                 willRemoveControllerList. add(removeController);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">for</span> (HTRouteController removeController: willRemoveControllerList) &#123;</span><br><span class="line">                 removeChildController(removeController);</span><br><span class="line">             &#125;</span><br><span class="line">             lock = <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Package-TabBar"><a href="#Package-TabBar" class="headerlink" title="Package TabBar"></a>Package TabBar</h2><p>From gesture analysis, we need to avoid JS.onPress, so we use the package of UITabBarController and UITabBar on the iOS platform. We only need to create a UITabBar and UITabBarController on the Android platform.</p>
<ul>
<li>Due to the diversity of TabBar, we just encapsulate a common example, and other projects can inherit and rewrite</li>
<li>For convenience, we use the code layout<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TabBar</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reloadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>. removeAllViews();</span><br><span class="line">     <span class="keyword">this</span>.initSeparatorLine(<span class="keyword">this</span>);</span><br><span class="line">     LinearLayout linearLayout = <span class="keyword">new</span> LinearLayout(HTRouteGlobal. activity);</span><br><span class="line">     <span class="keyword">this</span>.addView(linearLayout, HTRouteGlobal.matchParent);</span><br><span class="line">     linearLayout.setOrientation(LinearLayout.HORIZONTAL);</span><br><span class="line"></span><br><span class="line">     TypedValue typedValue = <span class="keyword">new</span> TypedValue();</span><br><span class="line">     <span class="keyword">int</span> imageId = android.R.attr.selectableItemBackground;</span><br><span class="line">     HTRouteGlobal.activity.getTheme().resolveAttribute(imageId, typedValue, <span class="keyword">true</span>);</span><br><span class="line">     <span class="keyword">int</span>[] attribute = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;imageId&#125;;</span><br><span class="line">     TypedArray typedArray = getContext().getTheme().obtainStyledAttributes(typedValue.resourceId, attribute);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; delegate. itemCount(); index ++) &#123;</span><br><span class="line">         ...</span><br><span class="line">         linearLayout. addView(relativeLayout);</span><br><span class="line">         reloadItemIndex(index);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Encapsulate-TabBarController"><a href="#Encapsulate-TabBarController" class="headerlink" title="Encapsulate TabBarController"></a>Encapsulate TabBarController</h2><ul>
<li>For the Controller that has been covered by the top page, we need to move it out of the Fragment to save memory</li>
<li>And we need to handle viewDidAppear and viewDidDisappear lifecycle<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">didItemSelected</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">     HTRouteFragment fragment = modelList.get(index).fragment;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (fragmentContainer. getChildCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         HTRouteFragment lastFragment = (HTRouteFragment) fragmentContainer.getChildAt(<span class="number">0</span>).getTag();</span><br><span class="line">         lastFragment. viewDidDisappear();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     View view = fragment. getView();</span><br><span class="line">     fragmentContainer. removeAllViews();</span><br><span class="line"></span><br><span class="line">     RelativeLayout.LayoutParams layoutParams = <span class="keyword">new</span> RelativeLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> bottom = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> (!TextUtils.isEmpty(HTRouteGlobal.getProp(<span class="string">&quot;ro.build.version.emui&quot;</span>))) &#123;</span><br><span class="line">         bottom = <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     layoutParams.setMargins(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, bottom);</span><br><span class="line">     fragmentContainer.addView(view, layoutParams);</span><br><span class="line"></span><br><span class="line">     fragment. viewDidAppear();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Encapsulate-RouteView"><a href="#Encapsulate-RouteView" class="headerlink" title="Encapsulate RouteView"></a>Encapsulate RouteView</h2><p>The most important point is that we can bind the pages and parameters that need to be redirected to RouteView. When the original click event is received, we can directly jump to the native page without going through JS.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTRouteViewManager</span></span><br><span class="line"><span class="meta">@ReactProp(name = &quot;routeData&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRouteData</span><span class="params">(HTRouteView routeView, ReadableMap routeDataMap)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> Map&lt;String, Object&gt; routeData = routeDataMap == <span class="keyword">null</span> ? <span class="keyword">null</span> : routeDataMap.toHashMap();</span><br><span class="line">     <span class="keyword">if</span> (routeData != <span class="keyword">null</span> &amp;&amp; routeData. size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         routeView.setClickable(<span class="keyword">true</span>);</span><br><span class="line">         <span class="keyword">final</span> WeakReference&lt;HTRouteView&gt; weakRouteView = <span class="keyword">new</span> WeakReference&lt;&gt;(routeView);</span><br><span class="line">         routeView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                 touchRouteData(weakRouteView. get(), routeData);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         routeView.setClickable(<span class="keyword">false</span>);</span><br><span class="line">         routeView.setOnClickListener(<span class="keyword">null</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="All-page-jump-processing"><a href="#All-page-jump-processing" class="headerlink" title="All page jump processing"></a>All page jump processing</h2><p>Including push replace presentModal all common processing</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HTRouteViewManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handlerRouteDataWithController</span><span class="params">(HTRouteController controller, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; routeData)</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">if</span> (action. equals(<span class="string">&quot;push&quot;</span>) || action. equals(<span class="string">&quot;navigate&quot;</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">         navigationController.pushViewController(routeController, animated, <span class="keyword">null</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action. equals(<span class="string">&quot;replace&quot;</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">         navigationController. replaceViewController(routeController, animated);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action. equals(<span class="string">&quot;pop&quot;</span>) || action. equals(<span class="string">&quot;back&quot;</span>) || action. equals(<span class="string">&quot;goBack&quot;</span>)) &#123;</span><br><span class="line">         navigationController. popViewController(animated);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action. equals(<span class="string">&quot;popToTop&quot;</span>) || action. equals(<span class="string">&quot;popToRoot&quot;</span>)) &#123;</span><br><span class="line">         navigationController.popToRootViewControllerAnimated(animated);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action. equals(<span class="string">&quot;present&quot;</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">         presentView.addView(presentBackgroundView, HTRouteGlobal.matchParent);</span><br><span class="line">         translatePresentAnimation(presentBackgroundView, presentNavigationController.getView(), presentEdgeTop, <span class="keyword">true</span>, presentAnimatedDuration, <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                 presentNavigationController. viewDidAppear();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action. equals(<span class="string">&quot;dismiss&quot;</span>)) &#123;</span><br><span class="line">         <span class="keyword">final</span> RelativeLayout presentView = rootPresentViewController();</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; presentView. getChildCount(); i ++) &#123;</span><br><span class="line">             <span class="keyword">final</span> ViewGroup presentBackgroundView = (ViewGroup) presentView. getChildAt(i);</span><br><span class="line">             View navigationControllerView = presentBackgroundView. getChildAt(<span class="number">0</span>);</span><br><span class="line">             <span class="keyword">final</span> HTRouteNavigationController presentNavigationController = HTRouteGlobal.nextController(navigationControllerView, HTRouteNavigationController.class);</span><br><span class="line">             HTRouteController routeController = presentNavigationController. childControllerList. get(<span class="number">0</span>);</span><br><span class="line">             <span class="keyword">if</span> (routeController. componentName. equals(componentName)) &#123;</span><br><span class="line">                 translatePresentAnimation(presentBackgroundView, presentNavigationController.getView(), presentEdgeTop, <span class="keyword">false</span>, presentAnimatedDuration, <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">                     <span class="meta">@Override</span></span><br><span class="line">                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                         presentView. removeView(presentBackgroundView);</span><br><span class="line">                         presentNavigationController. viewDidDisappear();</span><br><span class="line">                         presentNavigationController. dealloc();</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Same-interface-as-react-navigation"><a href="#Same-interface-as-react-navigation" class="headerlink" title="Same interface as react-navigation"></a>Same interface as react-navigation</h2><p>We need to leave the same interface as react-navigation on the JS side to facilitate switching at any time</p>
<h3 id="JS-parameter-passing"><a href="#JS-parameter-passing" class="headerlink" title="JS parameter passing"></a>JS parameter passing</h3><p>If function parameters need to be passed between pages, we need to store these variables in global variables, and then retrieve them through the key on the second page, because functions cannot be serialized</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> encodeRouteData = <span class="function">(<span class="params">routeData, navigation</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> reloadRouteData = &#123; ...routeData &#125;</span><br><span class="line">     <span class="keyword">let</span> componentName = reloadRouteData?.componentName</span><br><span class="line">     <span class="keyword">let</span> componentPropList = reloadRouteData?. componentPropList ?? &#123;&#125;</span><br><span class="line">     <span class="keyword">let</span> componentRouteOptionList = reloadRouteData?. componentRouteOptionList ?? &#123;&#125;</span><br><span class="line">     componentRouteOptionList = &#123;</span><br><span class="line">         ...HTRouteManager. defaultRouteOption(&#123; ...routeData, navigation &#125;),</span><br><span class="line">         ...componentRouteOptionList,</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span>(componentName) == <span class="string">&#x27;string&#x27;</span> &amp;&amp; !globalValue.registerList[componentName]) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> id = componentRouteOptionList[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">     <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">         globalValue.count += <span class="number">1</span></span><br><span class="line">         id = <span class="string">`<span class="subst">$&#123;globalValue.count&#125;</span>`</span></span><br><span class="line">     &#125;</span><br><span class="line">     componentRouteOptionList[<span class="string">&#x27;id&#x27;</span>] = id</span><br><span class="line"></span><br><span class="line">     reloadRouteData[<span class="string">&#x27;componentRouteOptionList&#x27;</span>] = componentRouteOptionList</span><br><span class="line"></span><br><span class="line">     sureComponentItem(id, &#123; componentPropList &#125;)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> reloadRouteData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decodeRouteData = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> reloadProps = &#123; ... props &#125;</span><br><span class="line">     <span class="keyword">let</span> componentRouteOptionList = reloadProps?. componentRouteOptionList ?? &#123;&#125;</span><br><span class="line">     <span class="keyword">let</span> id = componentRouteOptionList?.id</span><br><span class="line">     sureComponentItem(id)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> componentValueList = globalValue. componentList[id] ?? &#123;&#125;</span><br><span class="line">     <span class="keyword">let</span> componentPropList = componentValueList[<span class="string">&#x27;componentPropList&#x27;</span>] ?? &#123;&#125;</span><br><span class="line">     reloadProps.componentPropList = componentPropList</span><br><span class="line">     <span class="keyword">return</span> reloadProps</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="JS-Lifecycle"><a href="#JS-Lifecycle" class="headerlink" title="JS Lifecycle"></a>JS Lifecycle</h3><p>We need to receive the viewDidAppear and viewDidDisappear life cycle events sent by the native side, and then call the method of the corresponding component through the id</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> routeListener = HTRouteEventManagerEmitter. addListener(<span class="string">&#x27;onHTRouteEventChange&#x27;</span>, <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> id = value[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">     <span class="keyword">let</span> actionName = value[<span class="string">&#x27;actionName&#x27;</span>]</span><br><span class="line">     <span class="keyword">let</span> componentRef = globalValue.componentList[id]?.ref</span><br><span class="line">     <span class="keyword">if</span> (componentRef == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     DeviceEventEmitter. emit(<span class="string">&#x27;onHTRouteEvent&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;controller&#x27;</span>, <span class="attr">value</span>: value &#125;)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (value?. actionName == <span class="string">&#x27;dealloc&#x27;</span>) &#123;</span><br><span class="line">         globalValue.componentList[id].ref = <span class="literal">null</span></span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> componentFunction = componentRef[actionName]</span><br><span class="line">     <span class="keyword">if</span> (componentFunction == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     componentFunction. call(componentRef, value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Affiliated"><a href="#Affiliated" class="headerlink" title="Affiliated"></a>Affiliated</h2><p>The full code is here <a target="_blank" rel="noopener" href="https://github.com/hellohublot/react-native-route">https://github.com/hellohublot/react-native-route</a><br>I’m hublot, sharing some of my thoughts, I’m too busy with work, it’s inevitable that there will be negligence, please forgive me</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hellohublot.github.io/2022/02/23/Analyzing%20and%20optimizing%20ReactNative%20animations%20and%20gestures%20through%20source%20code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hublot@aliyun.com">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光荏苒">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/23/Analyzing%20and%20optimizing%20ReactNative%20animations%20and%20gestures%20through%20source%20code/" class="post-title-link" itemprop="url">Analyzing and optimizing ReactNative animations and gestures through source code</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-23 16:48:14" itemprop="dateCreated datePublished" datetime="2022-02-23T16:48:14+08:00">2022-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-25 16:49:41" itemprop="dateModified" datetime="2023-02-25T16:49:41+08:00">2023-02-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Why-is-it-stuck"><a href="#Why-is-it-stuck" class="headerlink" title="Why is it stuck"></a>Why is it stuck</h2><hr>
<p><img src="https://reactnative.dev/docs/assets/Architecture/threading-model/case-1.jpg"></p>
<p>Although the Main thread of most ReactNative applications does keep 60FPS, why sometimes we still feel stuck,<br>In fact, this is because of the asynchronous communication between the JS thread and the Main thread, resulting in the user’s gestures not being feedback in time, so our article mainly talks about the performance optimization of ReactNative applications</p>
<hr>
<h2 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h2><h3 id="JS-frame-animation"><a href="#JS-frame-animation" class="headerlink" title="JS frame animation"></a>JS frame animation</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/Libraries/Animated/animations/TimingAnimation.js#L126</span></span><br><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/Libraries/Core/Timers/JSTimers.js#L257</span></span><br><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/React/CoreModules/RCTTiming.mm#L334</span></span><br><span class="line"><span class="comment">// TimingAnimation</span></span><br><span class="line"><span class="comment">// Through the above call chain, you can see that the JS frame animation is triggered based on the timer loop</span></span><br><span class="line"><span class="built_in">this</span>._animationFrame = requestAnimationFrame(</span><br><span class="line">     <span class="built_in">this</span>.onUpdate.bind(<span class="built_in">this</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/React/CoreModules/RCTTiming.mm#L296</span></span><br><span class="line"><span class="comment">// RCTTiming</span></span><br><span class="line"><span class="comment">// Start an NSTimer on the JS thread</span></span><br><span class="line">- (<span class="keyword">void</span>)scheduleSleepTimer:(NSDate *)sleepTarget</span><br><span class="line">&#123;</span><br><span class="line">     <span class="meta">@synchronized(self)</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!_sleepTimer || !_sleepTimer.valid) &#123;</span><br><span class="line">             _sleepTimer = [[NSTimer alloc] initWithFireDate:sleepTarget</span><br><span class="line">                                                  interval: <span class="number">0</span></span><br><span class="line">                                                    target:[_RCTTimingProxy proxyWithTarget:self]</span><br><span class="line">                                                  selector: <span class="meta">@selector(timerDidFire)</span></span><br><span class="line">                                                  userInfo: nil</span><br><span class="line">                                                   repeats:NO];</span><br><span class="line">             [[NSRunLoop currentRunLoop] addTimer:_sleepTimer forMode:NSDefaultRunLoopMode];</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             _sleepTimer.fireDate = [_sleepTimer.fireDate earlierDate:sleepTarget];</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>requestAnimationFrame is a timer function exposed by Native to JS. Every time the timer triggers a frame animation, the JS thread will recalculate the layout, and then switch to the Main thread to update these layouts. Ordinary JS animations are generally very stuck, because the frame timer is in the The thread may be very busy, the communication between threads may take time to wait, and the frame timer keeps making the main thread refresh the interface while the main thread may also be busy, so it is very common to encounter performance problems when using JS animation. What are the common solutions?</p>
<h3 id="Native-frame-animation-useNativeDriver"><a href="#Native-frame-animation-useNativeDriver" class="headerlink" title="Native frame animation useNativeDriver"></a>Native frame animation useNativeDriver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/Libraries/NativeAnimation/RCTNativeAnimatedNodesManager.m#L429</span></span><br><span class="line"><span class="comment">// RCTNativeAnimatedNodesManager</span></span><br><span class="line"><span class="comment">// Start a CADisplayLink on the main thread</span></span><br><span class="line">- (<span class="keyword">void</span>)startAnimationLoopIfNeeded &#123;</span><br><span class="line">     <span class="keyword">if</span> (!_displayLink &amp;&amp; _activeAnimations.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         _displayLink = [CADisplayLink displayLinkWithTarget:self selector:<span class="meta">@selector(stepAnimations:)</span>];</span><br><span class="line">         [_displayLink addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSRunLoopCommonModes];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/Libraries/NativeAnimation/Drivers/RCTFrameAnimation.m#L85</span></span><br><span class="line"><span class="comment">// RCTFrameAnimation</span></span><br><span class="line"><span class="comment">// The selector bound to CADisplayLink will calculate the value change, and then directly call setNeedsDisplay on the main thread</span></span><br><span class="line">- (<span class="keyword">void</span>)stepAnimationWithTime:(NSTimeInterval)currentTime</span><br><span class="line">&#123;</span><br><span class="line">     ...</span><br><span class="line">     [self updateOutputWithFrameOutput:frameOutput];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateOutputWithFrameOutput:(CGFloat)frameOutput</span><br><span class="line">&#123;</span><br><span class="line">     ...</span><br><span class="line">     [_valueNode setNeedsUpdate];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>useNativeDriver, what is the actual function of this property? Looking the source code of ReactNative or react-native-reanimated, we can see that a variable value is bound in the native side, and a CADisplayLink is created. This frame timer is to change the bound variable value frame by frame, and then refresh the corresponding interface after the value is changed in the main thread, which will not involve JS thread communication, so most of the cases can help solve our performance problems, but there are sometimes we will still encounter animation performance problems that cannot be solved by useNativeDriver, Because the frame loss of CADisplayLink frame animation, how do we deal with this situation?</p>
<h3 id="Native-layout-animation-LayoutAnimation"><a href="#Native-layout-animation-LayoutAnimation" class="headerlink" title="Native layout animation LayoutAnimation"></a>Native layout animation LayoutAnimation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/React/Modules/RCTLayoutAnimation.m#L107-L127</span></span><br><span class="line"><span class="comment">// RCTLayoutAnimation</span></span><br><span class="line"><span class="comment">// LayoutAnimation will perform UIView animation through UIManager</span></span><br><span class="line">- (<span class="keyword">void</span>)performAnimations:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))animations withCompletionBlock:(<span class="keyword">void</span> (^)(BOOL completed))completionBlock</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">if</span> (_animationType == RCTAnimationTypeSpring) &#123;</span><br><span class="line">         [UIView animateWithDuration:_duration</span><br><span class="line">                               delay:_delay</span><br><span class="line">              usingSpringWithDamping:_springDamping</span><br><span class="line">               initialSpringVelocity:_initialVelocity</span><br><span class="line">                             options:UIViewAnimationOptionBeginFromCurrentState</span><br><span class="line">                          animations: animations</span><br><span class="line">                          completion:completionBlock];</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         UIViewAnimationOptions options =</span><br><span class="line">             UIViewAnimationOptionBeginFromCurrentState | UIViewAnimationOptionsFromRCTAnimationType(_animationType);</span><br><span class="line"></span><br><span class="line">         [UIView animateWithDuration:_duration</span><br><span class="line">                               delay:_delay</span><br><span class="line">                             options:options</span><br><span class="line">                          animations: animations</span><br><span class="line">                          completion:completionBlock];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LayoutAnimation can solve this problem, and why, we can find out by looking at the source code, because LayoutAnimation does not start the native frame animation, but the native UIView animation that comes with iOS, because the animation of iOS is a separate process for animation. This animation is a process animation and has nothing to do with threads, so even if the Main thread is too busy, the animation process will directly complete the animation. Similarly, the animation framework of android may also have its own optimization, such as hardware acceleration, etc.</p>
<h2 id="Gesture-Events"><a href="#Gesture-Events" class="headerlink" title="Gesture Events"></a>Gesture Events</h2><h3 id="JS-Gesture-Events"><a href="#JS-Gesture-Events" class="headerlink" title="JS Gesture Events"></a>JS Gesture Events</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/React/Base/RCTTouchHandler.m#L186</span></span><br><span class="line"><span class="comment">// RCTTouchHandler</span></span><br><span class="line"><span class="comment">// Every touch event on RootContentView will be sent to JS</span></span><br><span class="line">- (<span class="keyword">void</span>)_updateAndDispatchTouches:(NSSet&lt;UITouch *&gt; *)touches eventName:(NSString *)eventName &#123;</span><br><span class="line">     ...</span><br><span class="line">     RCTTouchEvent *event = [[RCTTouchEvent alloc] initWithEventName:eventName</span><br><span class="line">                                                          reactTag: self.view.reactTag</span><br><span class="line">                                                      reactTouches: reactTouches</span><br><span class="line">                                                    changedIndexes: changedIndexes</span><br><span class="line">                                                     coalescingKey:_coalescingKey];</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!canBeCoalesced) &#123;</span><br><span class="line">         _coalescingKey++;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     [_eventDispatcher sendEvent:event];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ordinary JS gesture processing is generally very slow, because the main thread receives the gesture, sends the gesture to the JS thread, and then executes the JS method. The Main thread receives the interface properties that should be updated, which involves two cross-threads Transferring data, among them, it is absolutely possible to wait for communication. How do we usually solve it?</p>
<h3 id="Native-Gesture-Events"><a href="#Native-Gesture-Events" class="headerlink" title="Native Gesture Events"></a>Native Gesture Events</h3><p>Similarly, the useNativeDriver mentioned above, we also have an event called nativeEvent, usually, them are used together, the native gesture will send a global notification, the animation framework will listen to this event, and then directly update the value of the animation binding As well as refreshing the interface directly on the main thread, we also don’t need asynchronous JS thread communication, so react-native-gesture-handler really solves a lot of performance problems</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react-native/blob/26b2bb5343f92672ed4e8f42c6f839e903124b06/Libraries/NativeAnimation/RCTNativeAnimatedModule.mm#L76</span></span><br><span class="line"><span class="comment">// RCTNativeAnimatedModule</span></span><br><span class="line"><span class="comment">// The animation framework will listen to all Event events, and then judge whether to update the bound animation value value according to the key</span></span><br><span class="line">- (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">     [[self.moduleRegistry moduleForName:<span class="string">&quot;EventDispatcher&quot;</span>] addDispatchObserver:self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Affiliated"><a href="#Affiliated" class="headerlink" title="Affiliated"></a>Affiliated</h2><p>I’m hublot, sharing some of my thoughts, I’m too busy with work, it’s inevitable that there will be negligence, please forgive me</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hublot@aliyun.com"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">hublot@aliyun.com</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hellohublot" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hellohublot" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hublot@aliyun.com" title="E-Mail → mailto:hublot@aliyun.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hublot@aliyun.com</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
